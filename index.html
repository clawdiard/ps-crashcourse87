<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CrashCourse '87 ‚Äî The Day the Market Broke</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0f;--surface:#12121a;--border:#1e1e2e;--text:#e0e0e8;--muted:#8888a0;--accent:#ff4444;--green:#00cc88;--gold:#ffaa00;--blue:#4488ff}
body{font-family:'Georgia','Times New Roman',serif;background:var(--bg);color:var(--text);line-height:1.6;overflow-x:hidden}
a{color:var(--blue);text-decoration:none}

/* Hero */
.hero{min-height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:2rem;position:relative;overflow:hidden}
.hero::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:radial-gradient(ellipse at center,rgba(255,68,68,0.08) 0%,transparent 70%)}
.hero h1{font-size:clamp(2.5rem,7vw,5rem);font-weight:400;letter-spacing:-0.02em;margin-bottom:0.5rem}
.hero h1 span{color:var(--accent);font-weight:700}
.hero .subtitle{font-size:clamp(1rem,2.5vw,1.4rem);color:var(--muted);max-width:600px;margin:0.5rem auto 2rem}
.hero .date-badge{display:inline-block;padding:0.5rem 1.5rem;border:1px solid var(--accent);color:var(--accent);font-family:'Courier New',monospace;font-size:1.1rem;letter-spacing:0.1em;margin-bottom:2rem}
.scroll-hint{position:absolute;bottom:2rem;color:var(--muted);font-size:0.9rem;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:0.4}50%{opacity:1}}

/* Ticker tape */
.ticker-wrap{background:var(--surface);border-bottom:1px solid var(--border);padding:0.6rem 0;overflow:hidden;position:sticky;top:0;z-index:100}
.ticker{display:flex;gap:2rem;animation:scroll 30s linear infinite;white-space:nowrap;font-family:'Courier New',monospace;font-size:0.85rem}
.ticker span.down{color:var(--accent)}
.ticker span.up{color:var(--green)}
@keyframes scroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}

/* Sections */
.section{max-width:900px;margin:0 auto;padding:4rem 2rem}
.section h2{font-size:clamp(1.6rem,4vw,2.4rem);margin-bottom:1.5rem;font-weight:400}
.section h2 span{color:var(--accent)}

/* Stats bar */
.stats-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin:2rem 0}
.stat{background:var(--surface);border:1px solid var(--border);padding:1.5rem;text-align:center;border-radius:4px}
.stat .number{font-size:2.2rem;font-weight:700;color:var(--accent);font-family:'Courier New',monospace}
.stat .label{color:var(--muted);font-size:0.85rem;margin-top:0.3rem}

/* Timeline */
.timeline{position:relative;margin:3rem 0;padding-left:2rem;border-left:2px solid var(--border)}
.timeline-event{margin-bottom:2.5rem;position:relative;opacity:0;transform:translateY(20px);transition:all 0.6s ease}
.timeline-event.visible{opacity:1;transform:translateY(0)}
.timeline-event::before{content:'';position:absolute;left:-2.55rem;top:0.4rem;width:12px;height:12px;background:var(--accent);border-radius:50%;border:2px solid var(--bg)}
.timeline-event .time{font-family:'Courier New',monospace;color:var(--accent);font-size:0.9rem;margin-bottom:0.3rem}
.timeline-event .content{background:var(--surface);border:1px solid var(--border);padding:1.2rem 1.5rem;border-radius:4px}
.timeline-event .content h3{font-size:1.1rem;margin-bottom:0.5rem;font-weight:600}
.timeline-event .content p{color:var(--muted);font-size:0.95rem}

/* Chart */
.chart-container{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:1.5rem;margin:2rem 0}
.chart-title{font-size:0.85rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:1rem}
canvas{width:100%!important;height:300px!important}

/* Aftermath */
.aftermath-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin:2rem 0}
.aftermath-card{background:var(--surface);border:1px solid var(--border);padding:1.5rem;border-radius:4px}
.aftermath-card h3{font-size:1rem;margin-bottom:0.5rem;color:var(--gold)}
.aftermath-card p{color:var(--muted);font-size:0.9rem}

/* Quotes */
.quote{border-left:3px solid var(--gold);padding:1.5rem 2rem;margin:2rem 0;background:rgba(255,170,0,0.03)}
.quote p{font-style:italic;font-size:1.1rem}
.quote .attribution{color:var(--muted);font-size:0.85rem;margin-top:0.5rem}

/* Footer */
footer{text-align:center;padding:3rem 2rem;color:var(--muted);font-size:0.85rem;border-top:1px solid var(--border)}

/* Interactive chart area */
.dow-chart{position:relative;width:100%;height:320px;background:var(--surface);border:1px solid var(--border);border-radius:4px;overflow:hidden;margin:2rem 0}
.dow-chart svg{width:100%;height:100%}
.dow-chart .tooltip{position:absolute;background:rgba(10,10,15,0.95);border:1px solid var(--accent);padding:0.5rem 0.8rem;font-family:'Courier New',monospace;font-size:0.8rem;pointer-events:none;display:none;border-radius:3px;z-index:10}

/* Audio narration controls */
.narration-fab{position:fixed;bottom:2rem;right:2rem;z-index:200;display:flex;align-items:center;gap:0.5rem}
.narration-btn{width:52px;height:52px;border-radius:50%;border:1px solid var(--border);background:var(--surface);color:var(--accent);font-size:1.4rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s;box-shadow:0 4px 20px rgba(0,0,0,0.4)}
.narration-btn:hover{background:var(--accent);color:var(--bg);transform:scale(1.08)}
.narration-btn.active{background:var(--accent);color:var(--bg);animation:pulse-btn 2s infinite}
@keyframes pulse-btn{0%,100%{box-shadow:0 4px 20px rgba(255,68,68,0.3)}50%{box-shadow:0 4px 30px rgba(255,68,68,0.6)}}
.narration-label{background:var(--surface);border:1px solid var(--border);padding:0.4rem 0.8rem;border-radius:4px;font-size:0.75rem;color:var(--muted);font-family:'Courier New',monospace;white-space:nowrap;opacity:0;transition:opacity 0.3s}
.narration-fab:hover .narration-label{opacity:1}
.narration-banner{position:fixed;top:0;left:0;right:0;z-index:300;background:rgba(255,68,68,0.12);border-bottom:1px solid var(--accent);padding:0.5rem 1rem;display:flex;align-items:center;gap:0.8rem;font-family:'Courier New',monospace;font-size:0.8rem;color:var(--accent);transform:translateY(-100%);transition:transform 0.3s}
.narration-banner.visible{transform:translateY(0)}
.narration-banner .wave{display:flex;gap:2px;align-items:center;height:16px}
.narration-banner .wave span{width:3px;background:var(--accent);border-radius:1px;animation:wave-bar 0.8s ease-in-out infinite}
.narration-banner .wave span:nth-child(1){height:4px;animation-delay:0s}
.narration-banner .wave span:nth-child(2){height:10px;animation-delay:0.1s}
.narration-banner .wave span:nth-child(3){height:6px;animation-delay:0.2s}
.narration-banner .wave span:nth-child(4){height:14px;animation-delay:0.3s}
.narration-banner .wave span:nth-child(5){height:8px;animation-delay:0.15s}
@keyframes wave-bar{0%,100%{height:4px}50%{height:14px}}
.narration-banner .now-text{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* Replay Mode */
.replay-section{max-width:900px;margin:0 auto;padding:4rem 2rem;text-align:center}
.replay-btn{display:inline-flex;align-items:center;gap:0.6rem;padding:1rem 2.5rem;background:transparent;border:2px solid var(--accent);color:var(--accent);font-family:'Courier New',monospace;font-size:1.1rem;letter-spacing:0.08em;cursor:pointer;transition:all 0.3s;border-radius:4px}
.replay-btn:hover{background:var(--accent);color:var(--bg);transform:scale(1.04)}
.replay-btn:disabled{opacity:0.4;cursor:default;transform:none}

.replay-overlay{position:fixed;inset:0;z-index:500;background:var(--bg);display:none;flex-direction:column;overflow:hidden}
.replay-overlay.active{display:flex}

.replay-header{display:flex;align-items:center;justify-content:space-between;padding:0.8rem 1.5rem;border-bottom:1px solid var(--border);font-family:'Courier New',monospace;flex-shrink:0}
.replay-clock{font-size:1.4rem;color:var(--accent);letter-spacing:0.1em}
.replay-dow{font-size:1.2rem}
.replay-dow .val{color:var(--accent);font-weight:700}
.replay-dow .pct{color:var(--accent);margin-left:0.5rem;font-size:0.9rem}
.replay-close{background:none;border:1px solid var(--border);color:var(--muted);font-size:0.85rem;padding:0.4rem 1rem;cursor:pointer;border-radius:3px;font-family:'Courier New',monospace}
.replay-close:hover{border-color:var(--accent);color:var(--accent)}

.replay-body{flex:1;display:flex;overflow:hidden}
.replay-chart-area{flex:1;position:relative;min-width:0;padding:1rem}
.replay-chart-area svg{width:100%;height:100%}
.replay-events{width:320px;flex-shrink:0;border-left:1px solid var(--border);overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:0.8rem}
.replay-event{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:1rem;opacity:0;transform:translateX(30px);transition:all 0.5s ease}
.replay-event.show{opacity:1;transform:translateX(0)}
.replay-event .re-time{color:var(--accent);font-family:'Courier New',monospace;font-size:0.8rem;margin-bottom:0.3rem}
.replay-event .re-title{font-weight:700;font-size:0.95rem;margin-bottom:0.3rem}
.replay-event .re-body{color:var(--muted);font-size:0.82rem;line-height:1.5}
.replay-event.flash{border-color:var(--accent);box-shadow:0 0 15px rgba(255,68,68,0.3)}

.replay-footer{display:flex;align-items:center;gap:1rem;padding:0.8rem 1.5rem;border-top:1px solid var(--border);flex-shrink:0}
.replay-progress{flex:1;height:4px;background:var(--surface);border-radius:2px;overflow:hidden;cursor:pointer}
.replay-progress-bar{height:100%;background:var(--accent);width:0%;transition:width 0.3s linear}
.replay-speed{background:none;border:1px solid var(--border);color:var(--muted);padding:0.3rem 0.8rem;cursor:pointer;border-radius:3px;font-family:'Courier New',monospace;font-size:0.8rem}
.replay-speed:hover{border-color:var(--accent);color:var(--accent)}
.replay-pause{background:none;border:1px solid var(--accent);color:var(--accent);width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;border-radius:50%;font-size:1rem}
.replay-pause:hover{background:var(--accent);color:var(--bg)}

@media(max-width:768px){
  .timeline{padding-left:1.5rem}
  .timeline-event::before{left:-2.05rem}
  .narration-fab{bottom:1rem;right:1rem}
  .replay-events{width:100%;border-left:none;border-top:1px solid var(--border);max-height:200px}
  .replay-body{flex-direction:column}
}
</style>
</head>
<body>

<div class="hero">
  <div class="date-badge">OCTOBER 19, 1987</div>
  <h1>CrashCourse <span>'87</span></h1>
  <p class="subtitle">The interactive story of Black Monday ‚Äî the worst single-day percentage decline in stock market history</p>
  <div class="scroll-hint">‚Üì Scroll to begin</div>
</div>

<div class="ticker-wrap">
  <div class="ticker" id="ticker"></div>
</div>

<div class="section">
  <h2>The <span>Numbers</span></h2>
  <div class="stats-bar">
    <div class="stat"><div class="number">-22.6%</div><div class="label">DJIA Single-Day Drop</div></div>
    <div class="stat"><div class="number">-508</div><div class="label">Points Lost</div></div>
    <div class="stat"><div class="number">$500B</div><div class="label">Market Value Erased</div></div>
    <div class="stat"><div class="number">604M</div><div class="label">Shares Traded (NYSE)</div></div>
  </div>
  <p style="color:var(--muted);margin-top:1rem">To put this in perspective: The 2008 financial crisis never saw a single day worse than -7.9%. Black Monday was nearly three times that ‚Äî in a single session.</p>
</div>

<div class="section">
  <h2>The <span>Buildup</span></h2>
  <div class="quote">
    <p>"The market had risen 44% since January. Everyone was a genius."</p>
    <div class="attribution">‚Äî Market historian</div>
  </div>
  <p>The summer of 1987 was euphoric. The Dow peaked at 2,722 on August 25th. The bull run had lasted five years. Portfolio insurance ‚Äî a hedging strategy using futures ‚Äî had become wildly popular, with over $60 billion in assets "protected." Nobody asked what would happen if everyone tried to sell at once.</p>
  <br>
  <p>Then came October. On Wednesday the 14th, the trade deficit report came in worse than expected. The market fell 95 points. Thursday: down another 58. Friday the 16th: the Dow dropped 108 points ‚Äî 4.6% ‚Äî on record volume. The weekend was filled with dread.</p>
</div>

<div class="section">
  <h2>Black Monday ‚Äî <span>Tick by Tick</span></h2>
  
  <div class="dow-chart" id="dowChart">
    <svg id="chartSvg" viewBox="0 0 800 300" preserveAspectRatio="none"></svg>
    <div class="tooltip" id="chartTooltip"></div>
  </div>
  
  <div class="timeline" id="timeline">
    <div class="timeline-event">
      <div class="time">Pre-Market ‚Äî 6:00 AM ET</div>
      <div class="content">
        <h3>Overseas Markets in Freefall</h3>
        <p>Hong Kong had crashed 11%. London was down 10% and still falling. S&P 500 futures were limit-down before New York even opened. Portfolio managers arrived at their desks to find the world already burning.</p>
      </div>
    </div>
    <div class="timeline-event">
      <div class="time">9:30 AM ‚Äî Market Open</div>
      <div class="content">
        <h3>The Opening Bell Nobody Wanted</h3>
        <p>Many NYSE stocks couldn't open ‚Äî no buyers. The Dow gapped down immediately. $500 million in sell orders hit the S&P futures pit in the first minutes. Market makers began stepping back.</p>
      </div>
    </div>
    <div class="timeline-event">
      <div class="time">10:00 AM ‚Äî Down 100 points</div>
      <div class="content">
        <h3>Portfolio Insurance Kicks In</h3>
        <p>The automated selling programs activated en masse. As prices fell, portfolio insurance models demanded more selling ‚Äî which pushed prices lower ‚Äî which triggered more selling. The doom loop had begun.</p>
      </div>
    </div>
    <div class="timeline-event">
      <div class="time">11:00 AM ‚Äî Down 200 points</div>
      <div class="content">
        <h3>"There Are No Buyers"</h3>
        <p>NYSE specialists were overwhelmed. Many couldn't maintain orderly markets. The ticker was running 75 minutes late ‚Äî traders had no idea where stocks actually stood. The futures market was pricing in total collapse.</p>
      </div>
    </div>
    <div class="timeline-event">
      <div class="time">12:30 PM ‚Äî Brief Rally</div>
      <div class="content">
        <h3>A False Hope</h3>
        <p>The Dow recovered about 100 points as some bargain hunters stepped in. For 20 minutes, it looked like the worst might be over. It wasn't.</p>
      </div>
    </div>
    <div class="timeline-event">
      <div class="time">1:30 PM ‚Äî The Abyss</div>
      <div class="content">
        <h3>Selling Accelerates</h3>
        <p>The brief rally was crushed. Portfolio insurance programs resumed selling with even more force. The Chicago Mercantile Exchange considered halting futures trading. The NYSE discussed closing entirely.</p>
      </div>
    </div>
    <div class="timeline-event">
      <div class="time">2:00 PM ‚Äî SEC Chairman Calls Reagan</div>
      <div class="content">
        <h3>Washington Watches in Horror</h3>
        <p>SEC Chairman David Ruder mentioned possibly closing the exchanges. The comment leaked, intensifying panic. Treasury Secretary James Baker and Fed Chairman Alan Greenspan were in emergency consultations.</p>
      </div>
    </div>
    <div class="timeline-event">
      <div class="time">3:00 PM ‚Äî Down 400 points</div>
      <div class="content">
        <h3>Cascade Failure</h3>
        <p>The selling was now indiscriminate. Blue chips, small caps, everything. Some stocks hadn't traded all day. The options market was in chaos. Margin calls were going unanswered.</p>
      </div>
    </div>
    <div class="timeline-event">
      <div class="time">4:00 PM ‚Äî The Closing Bell</div>
      <div class="content">
        <h3>Dow Closes at 1,738.74 ‚Äî Down 508 Points</h3>
        <p>The worst percentage decline in history: -22.6%. More than the 1929 crash. The ticker didn't finish printing until 5:17 PM. On trading floors across the world, people sat in stunned silence.</p>
      </div>
    </div>
    <div class="timeline-event">
      <div class="time">Evening ‚Äî After the Bell</div>
      <div class="content">
        <h3>The Night the System Nearly Died</h3>
        <p>The real crisis was just beginning. Major brokerages faced insolvency. Banks refused to extend credit. The clearing system was breaking down. If margin calls weren't met by Tuesday morning, the entire financial system could seize.</p>
      </div>
    </div>
    <div class="timeline-event">
      <div class="time">Tuesday 8:41 AM ‚Äî Greenspan Acts</div>
      <div class="content">
        <h3>"The Fed Stands Ready"</h3>
        <p>In a single sentence before markets opened, new Fed Chairman Alan Greenspan affirmed the Federal Reserve's "readiness to serve as a source of liquidity to support the economic and financial system." It worked. The panic broke. The Dow rose 102 points on Tuesday.</p>
      </div>
    </div>
  </div>
</div>

<div class="section">
  <h2>The <span>Aftermath</span></h2>
  <div class="aftermath-grid">
    <div class="aftermath-card">
      <h3>Circuit Breakers Born</h3>
      <p>The NYSE implemented trading halts at 7%, 13%, and 20% declines. These "circuit breakers" were directly created because of Black Monday.</p>
    </div>
    <div class="aftermath-card">
      <h3>Portfolio Insurance Died</h3>
      <p>The strategy that amplified the crash was largely abandoned. Assets under portfolio insurance dropped from $60B to near zero within a year.</p>
    </div>
    <div class="aftermath-card">
      <h3>The Fed's New Role</h3>
      <p>Greenspan's swift response established the modern "Fed put" ‚Äî the expectation that the central bank will intervene during market crises.</p>
    </div>
    <div class="aftermath-card">
      <h3>Recovery</h3>
      <p>The market recovered all losses within two years. By 1989, the Dow exceeded its August 1987 high. The economy never entered recession.</p>
    </div>
    <div class="aftermath-card">
      <h3>Market Structure Reformed</h3>
      <p>Electronic trading systems were accelerated. The NYSE moved toward automation. The specialist system was gradually phased out over the next two decades.</p>
    </div>
    <div class="aftermath-card">
      <h3>Risk Models Rewritten</h3>
      <p>The crash was a "25-standard-deviation event" ‚Äî essentially impossible according to existing models. It forced a complete rethinking of tail risk and market correlation assumptions.</p>
    </div>
  </div>
</div>

<div class="section">
  <h2><span>Lessons</span> That Echo</h2>
  <div class="quote">
    <p>"More money has been lost reaching for yield than at the point of a gun."</p>
    <div class="attribution">‚Äî Raymond DeVoe Jr.</div>
  </div>
  <div class="quote">
    <p>"In theory there is no difference between theory and practice. In practice there is."</p>
    <div class="attribution">‚Äî Yogi Berra (often quoted on Wall Street after '87)</div>
  </div>
  <p style="margin-top:2rem">Black Monday taught Wall Street that markets are not machines ‚Äî they are ecosystems of human fear and automated amplification. Every major crash since has echoed the same pattern: overconfidence, leverage, a trigger, then a feedback loop that overwhelms the exits.</p>
  <br>
  <p>The 1987 crash remains the single worst day in market history by percentage. Not 1929. Not 2008. Not 2020. One Monday in October, when the machines and the humans panicked together.</p>
</div>

<div class="narration-banner" id="narrationBanner">
  <div class="wave"><span></span><span></span><span></span><span></span><span></span></div>
  <div class="now-text" id="narrationNowText">Narrating‚Ä¶</div>
</div>

<div class="narration-fab" id="narrationFab">
  <span class="narration-label">Listen ‚Äî period news broadcast narration</span>
  <button class="narration-btn" id="narrationBtn" aria-label="Toggle audio narration">üîä</button>
</div>

<div class="replay-section">
  <h2 style="font-size:clamp(1.6rem,4vw,2.4rem);font-weight:400;margin-bottom:1rem">‚è™ <span style="color:var(--accent)">Relive It</span></h2>
  <p style="color:var(--muted);max-width:600px;margin:0 auto 2rem;font-size:1rem">Watch the entire trading day compressed into 5 minutes. The chart animates in real-time and news events appear exactly when they happened.</p>
  <button class="replay-btn" id="replayStartBtn">‚ñ∂ RELIVE BLACK MONDAY</button>
</div>

<div class="replay-overlay" id="replayOverlay">
  <div class="replay-header">
    <div class="replay-clock" id="replayClock">9:30 AM</div>
    <div class="replay-dow">DJIA <span class="val" id="replayDow">2,164</span><span class="pct" id="replayPct">0.0%</span></div>
    <button class="replay-close" id="replayCloseBtn">‚úï EXIT</button>
  </div>
  <div class="replay-body">
    <div class="replay-chart-area">
      <svg id="replayChartSvg" viewBox="0 0 800 400" preserveAspectRatio="none"></svg>
    </div>
    <div class="replay-events" id="replayEvents"></div>
  </div>
  <div class="replay-footer">
    <button class="replay-pause" id="replayPauseBtn">‚è∏</button>
    <div class="replay-progress" id="replayProgress"><div class="replay-progress-bar" id="replayProgressBar"></div></div>
    <button class="replay-speed" id="replaySpeedBtn">1√ó</button>
  </div>
</div>

<footer>
  <p>CrashCourse '87 ‚Äî An interactive history of Black Monday</p>
  <p style="margin-top:0.5rem">Data sourced from SEC reports, NYSE archives, and Federal Reserve records</p>
</footer>

<script>
// Ticker tape
const tickerData = [
  {sym:'DJIA',val:'-508.00',pct:'-22.61%',down:true},
  {sym:'S&P 500',val:'-57.86',pct:'-20.47%',down:true},
  {sym:'NASDAQ',val:'-46.12',pct:'-11.35%',down:true},
  {sym:'IBM',val:'-8.00',pct:'-6.3%',down:true},
  {sym:'GE',val:'-5.25',pct:'-10.8%',down:true},
  {sym:'EXXON',val:'-4.50',pct:'-12.1%',down:true},
  {sym:'GM',val:'-8.75',pct:'-14.2%',down:true},
  {sym:'AT&T',val:'-3.125',pct:'-11.7%',down:true},
  {sym:'MERCK',val:'-21.50',pct:'-13.0%',down:true},
  {sym:'DIS',val:'-8.375',pct:'-13.5%',down:true},
  {sym:'GOLD',val:'+$7.90',pct:'+1.7%',down:false},
  {sym:'T-BOND',val:'+2.5pts',pct:'Flight to safety',down:false},
  {sym:'USD/JPY',val:'-3.2%',pct:'Dollar crashes',down:true},
  {sym:'FTSE',val:'-249.6',pct:'-10.8%',down:true},
  {sym:'HSI',val:'-420.8',pct:'-11.1%',down:true}
];
const tickerEl=document.getElementById('ticker');
let html='';
for(let r=0;r<3;r++){tickerData.forEach(t=>{
  const cls=t.down?'down':'up';
  html+=`<span class="${cls}">${t.sym} ${t.val} (${t.pct})</span>`;
})}
tickerEl.innerHTML=html;

// Intraday chart - approximate DJIA levels on Oct 19, 1987
const intradayData=[
  {t:'9:30',v:2164},{t:'9:45',v:2130},{t:'10:00',v:2100},{t:'10:15',v:2070},
  {t:'10:30',v:2040},{t:'10:45',v:2020},{t:'11:00',v:2000},{t:'11:15',v:1980},
  {t:'11:30',v:1960},{t:'11:45',v:1950},{t:'12:00',v:1940},{t:'12:15',v:1960},
  {t:'12:30',v:1990},{t:'12:45',v:2010},{t:'1:00',v:1990},{t:'1:15',v:1960},
  {t:'1:30',v:1930},{t:'1:45',v:1900},{t:'2:00',v:1870},{t:'2:15',v:1850},
  {t:'2:30',v:1830},{t:'2:45',v:1810},{t:'3:00',v:1790},{t:'3:15',v:1770},
  {t:'3:30',v:1760},{t:'3:45',v:1750},{t:'4:00',v:1739}
];

const svg=document.getElementById('chartSvg');
const tooltip=document.getElementById('chartTooltip');
const W=800,H=300,pad={t:30,r:20,b:40,l:60};
const minV=1700,maxV=2200;
const xScale=i=>pad.l+i/(intradayData.length-1)*(W-pad.l-pad.r);
const yScale=v=>pad.t+(1-(v-minV)/(maxV-minV))*(H-pad.t-pad.b);

// Grid lines
for(let v=1800;v<=2200;v+=100){
  const y=yScale(v);
  const line=document.createElementNS('http://www.w3.org/2000/svg','line');
  Object.entries({x1:pad.l,x2:W-pad.r,y1:y,y2:y,stroke:'#1e1e2e','stroke-width':1}).forEach(([k,val])=>line.setAttribute(k,val));
  svg.appendChild(line);
  const txt=document.createElementNS('http://www.w3.org/2000/svg','text');
  txt.setAttribute('x',pad.l-8);txt.setAttribute('y',y+4);txt.setAttribute('fill','#8888a0');txt.setAttribute('font-size','11');txt.setAttribute('text-anchor','end');txt.setAttribute('font-family','Courier New');
  txt.textContent=v.toLocaleString();svg.appendChild(txt);
}

// Opening level line
const openY=yScale(2164);
const openLine=document.createElementNS('http://www.w3.org/2000/svg','line');
Object.entries({x1:pad.l,x2:W-pad.r,y1:openY,y2:openY,stroke:'#ffaa00','stroke-width':1,'stroke-dasharray':'4,4',opacity:0.5}).forEach(([k,v])=>openLine.setAttribute(k,v));
svg.appendChild(openLine);

// Area + line
let pathD='';let areaD=`M${xScale(0)},${yScale(intradayData[0].v)}`;
intradayData.forEach((d,i)=>{
  const x=xScale(i),y=yScale(d.v);
  if(i===0){pathD=`M${x},${y}`;areaD=`M${x},${y}`}
  else{pathD+=` L${x},${y}`;areaD+=` L${x},${y}`}
});
areaD+=` L${xScale(intradayData.length-1)},${H-pad.b} L${xScale(0)},${H-pad.b} Z`;

const area=document.createElementNS('http://www.w3.org/2000/svg','path');
area.setAttribute('d',areaD);area.setAttribute('fill','url(#redGrad)');
const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
const grad=document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
grad.setAttribute('id','redGrad');grad.setAttribute('x1','0');grad.setAttribute('y1','0');grad.setAttribute('x2','0');grad.setAttribute('y2','1');
const s1=document.createElementNS('http://www.w3.org/2000/svg','stop');s1.setAttribute('offset','0%');s1.setAttribute('stop-color','#ff4444');s1.setAttribute('stop-opacity','0.3');
const s2=document.createElementNS('http://www.w3.org/2000/svg','stop');s2.setAttribute('offset','100%');s2.setAttribute('stop-color','#ff4444');s2.setAttribute('stop-opacity','0.02');
grad.appendChild(s1);grad.appendChild(s2);defs.appendChild(grad);svg.appendChild(defs);
svg.appendChild(area);

const path=document.createElementNS('http://www.w3.org/2000/svg','path');
path.setAttribute('d',pathD);path.setAttribute('fill','none');path.setAttribute('stroke','#ff4444');path.setAttribute('stroke-width','2.5');
svg.appendChild(path);

// Time labels
['9:30','11:00','12:30','2:00','4:00'].forEach(t=>{
  const idx=intradayData.findIndex(d=>d.t===t);
  if(idx>=0){
    const txt=document.createElementNS('http://www.w3.org/2000/svg','text');
    txt.setAttribute('x',xScale(idx));txt.setAttribute('y',H-pad.b+20);txt.setAttribute('fill','#8888a0');txt.setAttribute('font-size','11');txt.setAttribute('text-anchor','middle');txt.setAttribute('font-family','Courier New');
    txt.textContent=t;svg.appendChild(txt);
  }
});

// Interactive dots
const chartEl=document.getElementById('dowChart');
intradayData.forEach((d,i)=>{
  const circle=document.createElementNS('http://www.w3.org/2000/svg','circle');
  circle.setAttribute('cx',xScale(i));circle.setAttribute('cy',yScale(d.v));circle.setAttribute('r','12');circle.setAttribute('fill','transparent');circle.setAttribute('cursor','pointer');
  circle.addEventListener('mouseenter',e=>{
    const drop=((d.v-2246)/2246*100).toFixed(1);
    tooltip.style.display='block';
    tooltip.innerHTML=`<strong>${d.t}</strong><br>DJIA: ${d.v.toLocaleString()}<br>Day: ${drop}%`;
  });
  circle.addEventListener('mousemove',e=>{
    const rect=chartEl.getBoundingClientRect();
    tooltip.style.left=(e.clientX-rect.left+12)+'px';
    tooltip.style.top=(e.clientY-rect.top-40)+'px';
  });
  circle.addEventListener('mouseleave',()=>{tooltip.style.display='none'});
  svg.appendChild(circle);
});

// ‚îÄ‚îÄ Audio Narration System ‚îÄ‚îÄ
const narrationScripts = [
  { section: 'hero', text: "October nineteenth, nineteen eighty-seven. This is a special report. The stock market has suffered its worst single-day decline in history. The Dow Jones Industrial Average has plummeted five hundred and eight points ‚Äî a staggering twenty-two point six percent loss. We take you now through the events of this extraordinary day." },
  { section: 'numbers', text: "The numbers are almost incomprehensible. Five hundred billion dollars in market value ‚Äî gone in six and a half hours. Six hundred and four million shares changed hands on the New York Stock Exchange alone, shattering every volume record. To put this in perspective: the nineteen twenty-nine crash that launched the Great Depression saw a decline of just twelve point eight percent. Black Monday was nearly twice as devastating." },
  { section: 'buildup', text: "In the summer of nineteen eighty-seven, Wall Street was riding high. The Dow had climbed forty-four percent since January. A new financial innovation called portfolio insurance promised to protect investors from any downturn. Over sixty billion dollars in assets were hedged with this strategy. But as one trader later remarked: when everyone has the same insurance, no one is actually insured." },
  { section: 'timeline', text: "The timeline of Black Monday reads like a horror story. Before New York even opened, Hong Kong had crashed eleven percent. London was down ten. When the opening bell rang at nine-thirty, many stocks simply could not open ‚Äî there were no buyers at any price. By ten o'clock, automated portfolio insurance programs began dumping futures contracts, creating a vicious cycle: lower prices triggered more selling, which drove prices even lower. By the afternoon, the New York Stock Exchange was discussing whether to shut down entirely. At four o'clock, when the closing bell finally rang, the Dow stood at seventeen thirty-eight ‚Äî down five hundred and eight points. The ticker tape didn't finish printing until five-seventeen." },
  { section: 'aftermath', text: "The aftermath reshaped modern finance. Circuit breakers were born ‚Äî automatic trading halts at seven, thirteen, and twenty percent declines. Portfolio insurance was abandoned almost overnight. And Federal Reserve Chairman Alan Greenspan established what would become known as the Fed Put: the expectation that the central bank would step in during market crises. His single sentence the next morning ‚Äî the Fed stands ready ‚Äî broke the panic and saved the system." },
  { section: 'lessons', text: "Black Monday remains the worst single day in stock market history by percentage. Not nineteen twenty-nine. Not two thousand eight. Not twenty-twenty. It taught Wall Street a lesson that keeps being forgotten and relearned: markets are not machines. They are ecosystems of human fear and automated amplification. And when the exits are crowded, not everyone gets out. This has been a special report." }
];

// Map sections to DOM elements
function getNarrationSections() {
  const sections = document.querySelectorAll('.section');
  return [
    { el: document.querySelector('.hero'), script: narrationScripts[0] },
    { el: sections[0], script: narrationScripts[1] },
    { el: sections[1], script: narrationScripts[2] },
    { el: sections[2], script: narrationScripts[3] },
    { el: sections[3], script: narrationScripts[4] },
    { el: sections[4], script: narrationScripts[5] }
  ];
}

class NarrationController {
  constructor() {
    this.active = false;
    this.currentIdx = -1;
    this.synth = window.speechSynthesis;
    this.voice = null;
    this.fab = document.getElementById('narrationFab');
    this.btn = document.getElementById('narrationBtn');
    this.banner = document.getElementById('narrationBanner');
    this.bannerText = document.getElementById('narrationNowText');
    this.sections = getNarrationSections();
    this.scrollObserver = null;
    this.btn.addEventListener('click', () => this.toggle());
    this.loadVoice();
  }

  loadVoice() {
    const pick = () => {
      const voices = this.synth.getVoices();
      // Prefer a deep male English voice for broadcast feel
      const prefs = ['Daniel','Google UK English Male','Microsoft David','Alex','English United Kingdom'];
      for (const p of prefs) {
        const v = voices.find(v => v.name.includes(p) && v.lang.startsWith('en'));
        if (v) { this.voice = v; return; }
      }
      this.voice = voices.find(v => v.lang.startsWith('en')) || voices[0];
    };
    pick();
    if (this.synth.onvoiceschanged !== undefined) this.synth.onvoiceschanged = pick;
  }

  toggle() {
    if (this.active) this.stop(); else this.start();
  }

  start() {
    this.active = true;
    this.btn.classList.add('active');
    this.btn.innerHTML = '‚è∏';
    this.banner.classList.add('visible');
    // Find which section is currently in view
    const scrollY = window.scrollY + window.innerHeight / 3;
    let startIdx = 0;
    for (let i = this.sections.length - 1; i >= 0; i--) {
      if (this.sections[i].el && this.sections[i].el.offsetTop <= scrollY) { startIdx = i; break; }
    }
    this.speak(startIdx);
    this.setupScrollWatch();
  }

  stop() {
    this.active = false;
    this.synth.cancel();
    this.btn.classList.remove('active');
    this.btn.innerHTML = 'üîä';
    this.banner.classList.remove('visible');
    this.currentIdx = -1;
    if (this.scrollObserver) { this.scrollObserver.disconnect(); this.scrollObserver = null; }
  }

  speak(idx) {
    if (!this.active || idx < 0 || idx >= this.sections.length) { if (idx >= this.sections.length) this.stop(); return; }
    if (idx === this.currentIdx && this.synth.speaking) return;
    this.synth.cancel();
    this.currentIdx = idx;
    const script = this.sections[idx].script;
    const utter = new SpeechSynthesisUtterance(script.text);
    if (this.voice) utter.voice = this.voice;
    utter.rate = 0.92;
    utter.pitch = 0.85;
    // Show current narration text in banner
    const label = ['OPENING','THE NUMBERS','THE BUILDUP','BLACK MONDAY','THE AFTERMATH','LESSONS'][idx] || '';
    this.bannerText.textContent = `‚ñ∂ ${label}: ${script.text.substring(0, 80)}‚Ä¶`;
    utter.onend = () => { if (this.active && idx === this.currentIdx) { /* wait for scroll to trigger next */ } };
    this.synth.speak(utter);
  }

  setupScrollWatch() {
    if (this.scrollObserver) this.scrollObserver.disconnect();
    this.scrollObserver = new IntersectionObserver(entries => {
      if (!this.active) return;
      entries.forEach(e => {
        if (e.isIntersecting) {
          const idx = this.sections.findIndex(s => s.el === e.target);
          if (idx >= 0 && idx !== this.currentIdx) this.speak(idx);
        }
      });
    }, { threshold: 0.35 });
    this.sections.forEach(s => { if (s.el) this.scrollObserver.observe(s.el); });
  }
}

// Chrome bug: speechSynthesis pauses after ~15s. Keep-alive workaround.
setInterval(() => { if (window.speechSynthesis.speaking) window.speechSynthesis.resume(); }, 10000);

let narrationCtrl;
document.addEventListener('DOMContentLoaded', () => { narrationCtrl = new NarrationController(); });

// ‚îÄ‚îÄ Replay Mode: Relive It ‚îÄ‚îÄ
(function(){
  // Minute-by-minute DJIA data (approximate, 9:30 AM to 4:00 PM = 390 minutes)
  // We'll interpolate from the intradayData already defined above
  const openVal=2246; // Friday close
  const replayPoints=[];
  // Expand intradayData to per-minute (390 data points for 9:30-4:00)
  const rawTimes=intradayData.map(d=>{
    const [h,m]=d.t.split(':').map(Number);
    return (h*60+m)-570; // minutes since 9:30
  });
  const rawVals=intradayData.map(d=>d.v);
  for(let min=0;min<=390;min++){
    let i=0;
    for(let j=0;j<rawTimes.length-1;j++){if(rawTimes[j+1]<=min)i=j+1;else break;}
    if(i>=rawTimes.length-1){replayPoints.push(rawVals[rawVals.length-1]);continue;}
    const t1=rawTimes[i],t2=rawTimes[i+1],v1=rawVals[i],v2=rawVals[i+1];
    const frac=(min-t1)/(t2-t1);
    // Add some noise for realism
    const noise=(Math.random()-0.5)*8;
    replayPoints.push(Math.round(v1+(v2-v1)*frac+noise));
  }

  // Events with minute offsets from 9:30
  const replayEventsData=[
    {min:0,title:'Markets Open',body:'Massive sell orders flood the NYSE. Many stocks can\'t find opening prices. S&P futures already limit-down.'},
    {min:15,title:'Panic on the Floor',body:'$500M in sell orders hit the S&P futures pit. Traders are shouting but nobody is buying.'},
    {min:30,title:'Portfolio Insurance Activates',body:'Automated selling programs begin executing. The feedback loop starts: lower prices ‚Üí more selling ‚Üí lower prices.'},
    {min:60,title:'Down 100 Points',body:'The Dow has fallen 100 points in the first hour. NYSE specialists are overwhelmed.'},
    {min:90,title:'Down 200 Points',body:'"There are no buyers" ‚Äî the ticker is running 75 minutes behind. Nobody knows true prices.'},
    {min:120,title:'SEC Monitoring Situation',body:'SEC officials are in emergency session. Phone lines to the White House are active.'},
    {min:150,title:'Brief Rally Attempt',body:'Bargain hunters push the Dow up ~100 points. For 20 minutes, hope flickers.'},
    {min:180,title:'Rally Crushed',body:'Portfolio insurance programs resume selling with even greater force. The brief hope is destroyed.'},
    {min:210,title:'CME Considers Halt',body:'The Chicago Mercantile Exchange debates halting futures trading. NYSE discusses closing entirely.'},
    {min:240,title:'SEC Chairman Calls Reagan',body:'David Ruder mentions possibly closing exchanges. The comment leaks, intensifying panic.'},
    {min:270,title:'Down 400 Points',body:'Selling is now completely indiscriminate. Blue chips, small caps ‚Äî everything is being dumped.'},
    {min:300,title:'Cascade Failure',body:'Some stocks haven\'t traded all day. The options market is in chaos. Margin calls going unanswered.'},
    {min:330,title:'Final Hour Collapse',body:'The last hour of trading is the worst. Sellers have given up trying to get good prices ‚Äî they just want out.'},
    {min:390,title:'Closing Bell',body:'DJIA closes at 1,738.74. Down 508 points ‚Äî 22.6%. The worst single day in history. The ticker won\'t finish until 5:17 PM.'}
  ];

  const TOTAL_DURATION=5*60*1000; // 5 minutes in ms
  let speed=1, paused=false, running=false, startTime=0, elapsed=0, pausedAt=0, rafId=null;

  const overlay=document.getElementById('replayOverlay');
  const clockEl=document.getElementById('replayClock');
  const dowEl=document.getElementById('replayDow');
  const pctEl=document.getElementById('replayPct');
  const eventsEl=document.getElementById('replayEvents');
  const progressBar=document.getElementById('replayProgressBar');
  const chartSvg2=document.getElementById('replayChartSvg');
  const pauseBtn=document.getElementById('replayPauseBtn');
  const speedBtn=document.getElementById('replaySpeedBtn');
  const speeds=[1,2,4];
  let speedIdx=0;

  function minToTime(min){
    const totalMin=min+570;
    let h=Math.floor(totalMin/60),m=totalMin%60;
    const ampm=h>=12?'PM':'AM';
    if(h>12)h-=12;if(h===0)h=12;
    return `${h}:${String(m).padStart(2,'0')} ${ampm}`;
  }

  function drawReplayChart(upToMin){
    chartSvg2.innerHTML='';
    const W=800,H=400,pad={t:30,r:20,b:40,l:65};
    const minV=1680,maxV=2250;
    const xS=i=>pad.l+(i/390)*(W-pad.l-pad.r);
    const yS=v=>pad.t+(1-(v-minV)/(maxV-minV))*(H-pad.t-pad.b);

    // Defs
    const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
    const gr=document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
    gr.setAttribute('id','rGrad');gr.setAttribute('x1','0');gr.setAttribute('y1','0');gr.setAttribute('x2','0');gr.setAttribute('y2','1');
    const st1=document.createElementNS('http://www.w3.org/2000/svg','stop');st1.setAttribute('offset','0%');st1.setAttribute('stop-color','#ff4444');st1.setAttribute('stop-opacity','0.25');
    const st2=document.createElementNS('http://www.w3.org/2000/svg','stop');st2.setAttribute('offset','100%');st2.setAttribute('stop-color','#ff4444');st2.setAttribute('stop-opacity','0.02');
    gr.appendChild(st1);gr.appendChild(st2);defs.appendChild(gr);chartSvg2.appendChild(defs);

    // Grid
    for(let v=1800;v<=2200;v+=100){
      const y=yS(v);
      const ln=document.createElementNS('http://www.w3.org/2000/svg','line');
      Object.entries({x1:pad.l,x2:W-pad.r,y1:y,y2:y,stroke:'#1e1e2e','stroke-width':1}).forEach(([k,val])=>ln.setAttribute(k,val));
      chartSvg2.appendChild(ln);
      const tx=document.createElementNS('http://www.w3.org/2000/svg','text');
      tx.setAttribute('x',pad.l-8);tx.setAttribute('y',y+4);tx.setAttribute('fill','#8888a0');tx.setAttribute('font-size','11');tx.setAttribute('text-anchor','end');tx.setAttribute('font-family','Courier New');
      tx.textContent=v.toLocaleString();chartSvg2.appendChild(tx);
    }

    // Open line
    const oY=yS(openVal);
    const oLn=document.createElementNS('http://www.w3.org/2000/svg','line');
    Object.entries({x1:pad.l,x2:W-pad.r,y1:oY,y2:oY,stroke:'#ffaa00','stroke-width':1,'stroke-dasharray':'4,4',opacity:0.4}).forEach(([k,v])=>oLn.setAttribute(k,v));
    chartSvg2.appendChild(oLn);
    const oTx=document.createElementNS('http://www.w3.org/2000/svg','text');
    oTx.setAttribute('x',W-pad.r+4);oTx.setAttribute('y',oY+4);oTx.setAttribute('fill','#ffaa00');oTx.setAttribute('font-size','10');oTx.setAttribute('font-family','Courier New');
    oTx.textContent='Fri Close';chartSvg2.appendChild(oTx);

    // Time labels
    [0,60,120,180,240,300,390].forEach(m=>{
      const tx=document.createElementNS('http://www.w3.org/2000/svg','text');
      tx.setAttribute('x',xS(m));tx.setAttribute('y',H-pad.b+18);tx.setAttribute('fill','#8888a0');tx.setAttribute('font-size','10');tx.setAttribute('text-anchor','middle');tx.setAttribute('font-family','Courier New');
      tx.textContent=minToTime(m);chartSvg2.appendChild(tx);
    });

    // Draw line + area up to current minute
    const maxI=Math.min(Math.floor(upToMin),390);
    if(maxI<1)return;
    let ld=`M${xS(0)},${yS(replayPoints[0])}`;
    let ad=`M${xS(0)},${yS(replayPoints[0])}`;
    for(let i=1;i<=maxI;i++){
      ld+=` L${xS(i)},${yS(replayPoints[i])}`;
      ad+=` L${xS(i)},${yS(replayPoints[i])}`;
    }
    ad+=` L${xS(maxI)},${H-pad.b} L${xS(0)},${H-pad.b} Z`;

    const area=document.createElementNS('http://www.w3.org/2000/svg','path');
    area.setAttribute('d',ad);area.setAttribute('fill','url(#rGrad)');chartSvg2.appendChild(area);
    const line=document.createElementNS('http://www.w3.org/2000/svg','path');
    line.setAttribute('d',ld);line.setAttribute('fill','none');line.setAttribute('stroke','#ff4444');line.setAttribute('stroke-width','2.5');chartSvg2.appendChild(line);

    // Current price dot
    const cx=xS(maxI),cy=yS(replayPoints[maxI]);
    const dot=document.createElementNS('http://www.w3.org/2000/svg','circle');
    dot.setAttribute('cx',cx);dot.setAttribute('cy',cy);dot.setAttribute('r','5');dot.setAttribute('fill','#ff4444');
    chartSvg2.appendChild(dot);
    // Glow
    const glow=document.createElementNS('http://www.w3.org/2000/svg','circle');
    glow.setAttribute('cx',cx);glow.setAttribute('cy',cy);glow.setAttribute('r','10');glow.setAttribute('fill','none');glow.setAttribute('stroke','#ff4444');glow.setAttribute('stroke-width','1.5');glow.setAttribute('opacity','0.4');
    chartSvg2.appendChild(glow);
  }

  let shownEvents=new Set();

  function showEventsUpTo(min){
    replayEventsData.forEach((ev,i)=>{
      if(ev.min<=min && !shownEvents.has(i)){
        shownEvents.add(i);
        const div=document.createElement('div');
        div.className='replay-event';
        div.innerHTML=`<div class="re-time">${minToTime(ev.min)}</div><div class="re-title">${ev.title}</div><div class="re-body">${ev.body}</div>`;
        eventsEl.appendChild(div);
        requestAnimationFrame(()=>{
          div.classList.add('show','flash');
          setTimeout(()=>div.classList.remove('flash'),2000);
          eventsEl.scrollTop=eventsEl.scrollHeight;
        });
      }
    });
  }

  function tick(){
    if(!running)return;
    if(paused){rafId=requestAnimationFrame(tick);return;}
    const now=performance.now();
    elapsed+=(now-startTime)*speed;
    startTime=now;
    const progress=Math.min(elapsed/TOTAL_DURATION,1);
    const currentMin=progress*390;

    clockEl.textContent=minToTime(Math.min(Math.floor(currentMin),390));
    const idx=Math.min(Math.floor(currentMin),390);
    const val=replayPoints[idx];
    dowEl.textContent=val.toLocaleString();
    const pct=((val-openVal)/openVal*100).toFixed(1);
    pctEl.textContent=`${pct}%`;
    progressBar.style.width=`${progress*100}%`;

    drawReplayChart(currentMin);
    showEventsUpTo(currentMin);

    if(progress>=1){
      running=false;
      pauseBtn.textContent='‚Ü∫';
      return;
    }
    rafId=requestAnimationFrame(tick);
  }

  function startReplay(){
    overlay.classList.add('active');
    document.body.style.overflow='hidden';
    eventsEl.innerHTML='';
    shownEvents.clear();
    elapsed=0;paused=false;running=true;speedIdx=0;speed=1;
    speedBtn.textContent='1√ó';
    pauseBtn.textContent='‚è∏';
    startTime=performance.now();
    rafId=requestAnimationFrame(tick);
  }

  function stopReplay(){
    running=false;paused=false;
    if(rafId)cancelAnimationFrame(rafId);
    overlay.classList.remove('active');
    document.body.style.overflow='';
  }

  document.getElementById('replayStartBtn').addEventListener('click',startReplay);
  document.getElementById('replayCloseBtn').addEventListener('click',stopReplay);

  pauseBtn.addEventListener('click',()=>{
    if(!running){startReplay();return;}
    paused=!paused;
    if(!paused)startTime=performance.now();
    pauseBtn.textContent=paused?'‚ñ∂':'‚è∏';
  });

  speedBtn.addEventListener('click',()=>{
    speedIdx=(speedIdx+1)%speeds.length;
    speed=speeds[speedIdx];
    speedBtn.textContent=speed+'√ó';
  });

  // Keyboard: Escape to close, Space to pause
  document.addEventListener('keydown',e=>{
    if(!overlay.classList.contains('active'))return;
    if(e.key==='Escape')stopReplay();
    if(e.key===' '){e.preventDefault();pauseBtn.click();}
  });
})();

// Scroll reveal for timeline
const observer=new IntersectionObserver(entries=>{
  entries.forEach(e=>{if(e.isIntersecting)e.target.classList.add('visible')});
},{threshold:0.2});
document.querySelectorAll('.timeline-event').forEach(el=>observer.observe(el));
</script>
</body>
</html>
